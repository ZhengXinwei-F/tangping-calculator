<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å·¥èµ„è®¡ç®—å™¨ - äº”é™©ä¸€é‡‘ & å¹´ç»ˆå¥–</title>
<style>
  * { box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
  }
  .container {
    max-width: 1600px;
    margin: 0 auto;
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    padding: 32px;
  }
  h2 {
    margin: 0 0 24px 0;
    font-size: 28px;
    font-weight: 700;
    color: #2d3748;
    text-align: center;
    padding-bottom: 16px;
    border-bottom: 3px solid #667eea;
  }
  .input-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
    padding: 24px;
    background: #f7fafc;
    border-radius: 12px;
  }
  label {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-weight: 500;
    color: #4a5568;
    font-size: 14px;
  }
  input, select {
    font-size: 14px;
    padding: 10px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    transition: all 0.2s;
    background: white;
  }
  input:focus, select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  button {
    font-size: 15px;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    grid-column: 1 / -1;
    margin-top: 8px;
  }
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }
  #specialDeductionTable {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    font-size: 13px;
  }
  #specialDeductionTable tbody tr {
    border-bottom: 1px solid #e2e8f0;
  }
  #specialDeductionTable tbody tr:hover {
    background: #f7fafc;
  }
  #specialDeductionTable tbody tr:last-child {
    border-bottom: none;
  }
  #specialDeductionTable th,
  #specialDeductionTable td {
    padding: 8px 6px;
  }
  #specialDeductionTable th:first-child,
  #specialDeductionTable td:first-child {
    width: 40%;
    min-width: 120px;
  }
  #specialDeductionTable th:nth-child(2),
  #specialDeductionTable td:nth-child(2) {
    width: 35%;
  }
  #specialDeductionTable th:nth-child(3),
  #specialDeductionTable td:nth-child(3) {
    width: 25%;
  }
  .results {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-top: 24px;
  }
  .result-card {
    background: #f7fafc;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .result-card h3 {
    margin: 0 0 16px 0;
    font-size: 18px;
    color: #2d3748;
    padding-bottom: 12px;
    border-bottom: 2px solid #667eea;
  }
  .result-card > div {
    width: 100%;
    overflow-x: auto;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    max-width: 100%;
    background: white;
    font-size: 11px;
    border-radius: 8px;
    overflow: hidden;
    table-layout: fixed;
  }
  thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  th {
    padding: 8px 6px;
    text-align: right;
    font-weight: 600;
    font-size: 11px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  th:first-child {
    text-align: left;
    width: 8%;
  }
  th:nth-child(2) { width: 12%; } /* æœˆè–ª */
  th:nth-child(3) { width: 10%; } /* äº”é™© */
  th:nth-child(4) { width: 10%; } /* ä¸€é‡‘ */
  th:nth-child(5) { width: 14%; } /* ä¸ªç¨(ç¨ç‡) */
  th:nth-child(6) { width: 14%; } /* ç´¯è®¡è®¡ç¨æ•°é¢ */
  th:nth-child(7) { width: 12%; } /* å®å‘å·¥èµ„ */
  th:nth-child(8) { width: 10%; } /* åŒ»ä¿è´¦æˆ· */
  th:nth-child(9) { width: 10%; } /* å…¬ç§¯é‡‘è´¦æˆ· */
  tbody tr {
    border-bottom: 1px solid #e2e8f0;
    height: auto;
  }
  tbody tr:nth-child(even) {
    background: #f9fafb;
  }
  tbody tr:hover {
    background: #f0f4f8;
  }
  tbody tr[style*="background"] {
    height: auto;
    line-height: normal;
  }
  /* æ¡Œé¢ç«¯æœˆä»½åˆ—èƒŒæ™¯è‰² */
  .result-card table tbody td:first-child {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 700;
  }
  td {
    padding: 8px 6px;
    text-align: right;
    color: #4a5568;
    font-size: 11px;
    vertical-align: middle;
    line-height: 1.4;
    white-space: nowrap;
  }
  td:first-child {
    text-align: left;
    font-weight: 600;
    color: #2d3748;
  }
  th {
    white-space: nowrap;
  }
  .summary {
    margin-top: 24px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    color: white;
  }
  .summary h3 {
    margin: 0 0 16px 0;
    font-size: 20px;
  }
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }
  .summary-item {
    background: rgba(255,255,255,0.1);
    padding: 12px;
    border-radius: 8px;
  }
  .summary-item.highlight {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
    transform: scale(1.05);
    border: 2px solid #fbbf24;
  }
  .summary-item.highlight strong {
    color: white;
  }
  .summary-item.highlight span {
    color: white;
  }
  .summary-item strong {
    display: block;
    font-size: 12px;
    opacity: 0.9;
    margin-bottom: 4px;
  }
  .summary-item span {
    font-size: 20px;
    font-weight: 700;
  }
  @media (max-width: 768px) {
    body {
      padding: 10px;
    }
    .container {
      padding: 16px;
    }
    h2 {
      font-size: 20px;
      margin-bottom: 16px;
      padding-bottom: 12px;
    }
    .input-section {
      grid-template-columns: 1fr;
      padding: 16px;
      gap: 12px;
    }
    label {
      font-size: 13px;
    }
    input, select {
      font-size: 16px; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
      padding: 12px;
    }
    button {
      font-size: 14px;
      padding: 14px 20px;
      width: 100%;
    }
    .results {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    /* ç»“æœè¡¨æ ¼ç§»åŠ¨ç«¯ä¼˜åŒ– */
    .result-card table {
      font-size: 11px;
      display: block;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .result-card table thead {
      display: none;
    }
    .result-card table tbody,
    .result-card table tr {
      display: block;
    }
    .result-card table tbody tr {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 8px;
      padding: 10px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .result-card table tbody td {
      display: flex;
      flex-direction: row;
      border: none;
      padding: 10px 0;
      text-align: left;
      font-size: 12px;
      min-height: 36px;
      align-items: center;
    }
    .result-card table tbody td:before {
      content: attr(data-label);
      font-weight: 600;
      color: #4a5568;
      font-size: 11px;
      min-width: 100px;
      flex-shrink: 0;
      margin-right: 12px;
    }
    .result-card table tbody td:first-child {
      font-weight: 700;
      font-size: 13px;
      color: white;
      padding: 10px 12px;
      margin: -10px -10px 8px -10px;
      width: calc(100% + 20px);
      min-height: auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 6px;
      display: block;
      text-align: center;
    }
    .result-card table tbody td:first-child:before {
      display: none;
    }
    .result-card table tbody td strong {
      color: #667eea;
      font-size: 13px;
    }
    /* ä¸“é¡¹æ‰£é™¤è¡¨æ ¼ç§»åŠ¨ç«¯ä¼˜åŒ– - ä¿æŒè¡¨æ ¼æ ·å¼ï¼Œåªè°ƒæ•´å­—ä½“å’Œé—´è· */
    #specialDeductionTable {
      font-size: 11px;
    }
    #specialDeductionTable th,
    #specialDeductionTable td {
      padding: 6px 4px;
      font-size: 11px;
    }
    #specialDeductionTable th {
      font-size: 10px;
    }
    #addSpecialDeduction {
      width: 100%;
      margin-top: 12px;
    }
    .summary-grid {
      grid-template-columns: 1fr;
    }
  }
  
  @media (max-width: 480px) {
    body {
      padding: 8px;
    }
    .container {
      padding: 12px;
    }
    h2 {
      font-size: 18px;
      margin-bottom: 12px;
    }
    .input-section {
      padding: 12px;
      gap: 10px;
    }
    table {
      font-size: 11px;
    }
    th, td {
      padding: 6px 4px;
    }
    #specialDeductionTable {
      font-size: 10px;
    }
    #specialDeductionTable th,
    #specialDeductionTable td {
      padding: 4px 2px;
      font-size: 10px;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <h2>ğŸ’° å·¥èµ„è®¡ç®—å™¨ - äº”é™©ä¸€é‡‘ & å¹´ç»ˆå¥–</h2>

    <div class="input-section">
      <label>æœˆè–ª (å…ƒ)ï¼š<input id="monthlySalary" type="number" value="10000" /></label>
      <label>å¹´ç»ˆå¥– (å…ƒ)ï¼š<input id="bonus" type="number" value="30000" /></label>
      <label>å¹´ç»ˆå¥–åˆ°è´¦æœˆä»½ï¼š<select id="bonusMonth"><option value="12">12æœˆ</option><option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option><option value="4">4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option><option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option><option value="10">10æœˆ</option><option value="11">11æœˆ</option></select></label>
      <div style="grid-column: 1 / -1;">
        <label style="margin-bottom: 8px;">ä¸“é¡¹æ‰£é™¤ï¼š</label>
        <table id="specialDeductionTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
          <thead>
            <tr style="background: #667eea; color: white;">
              <th style="padding: 10px; text-align: left; font-size: 13px;">ç±»å‹</th>
              <th style="padding: 10px; text-align: left; font-size: 13px;">é‡‘é¢</th>
              <th style="padding: 10px; text-align: center; font-size: 13px; width: 80px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="specialDeductionBody">
            <!-- åŠ¨æ€æ·»åŠ è¡Œ -->
          </tbody>
        </table>
        <button type="button" id="addSpecialDeduction" style="margin-top: 8px; padding: 8px 16px; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">+ æ·»åŠ ä¸“é¡¹æ‰£é™¤</button>
      </div>
      <label>äº”é™©ä¸€é‡‘åŸºæ•° (å…ƒï¼Œç•™ç©ºåˆ™ä½¿ç”¨æœˆè–ª)ï¼š<input id="insuranceBase" type="number" /></label>
      <label>äº”é™©åŸºæ•°ä¸Šé™ (å…ƒ)ï¼ˆé»˜è®¤ï¼šæ­å·ï¼‰ï¼š<input id="insuranceMax" type="number" value="25299" /></label>
      <label>å…¬ç§¯é‡‘åŸºæ•°ä¸Šé™ (å…ƒ)ï¼ˆé»˜è®¤ï¼šæ­å·ï¼‰ï¼š<input id="housingMax" type="number" value="40694" /></label>
      <details style="margin: 10px 0;">
        <summary style="cursor: pointer; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 6px; user-select: none;">ğŸ“‹ äº”é™©ä¸€é‡‘æ¯”ä¾‹è®¾ç½®ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>
        <div style="padding: 10px 0 0 10px;">
          <label>å…»è€ä¿é™©æ¯”ä¾‹ (%)ï¼š<input id="pensionRate" type="number" step="0.1" value="8" /></label>
          <label>åŒ»ç–—ä¿é™©æ¯”ä¾‹ (%)ï¼š<input id="medicalRate" type="number" step="0.1" value="2" /></label>
          <label>å¤±ä¸šä¿é™©æ¯”ä¾‹ (%)ï¼š<input id="unemploymentRate" type="number" step="0.1" value="0.5" /></label>
          <label>å…¬ç§¯é‡‘æ¯”ä¾‹ (%)ï¼š<input id="housingRate" type="number" step="0.1" value="12" /></label>
          <label>åŒ»ä¿ä¸ªäººè´¦æˆ·æ¯”ä¾‹ (%)ï¼š<input id="medicalAccountRate" type="number" step="0.1" value="2" /></label>
        </div>
      </details>
      <button id="calculate">ğŸš€ è®¡ç®—</button>
    </div>

    <div id="results" style="display: none;">
      <div class="results">
        <div class="result-card">
          <h3>åˆå¹¶è®¡ç¨ï¼ˆå¹´ç»ˆå¥–å¹¶å…¥ç»¼åˆæ‰€å¾—ï¼‰</h3>
          <div id="combinedTable"></div>
        </div>
        <div class="result-card">
          <h3>åˆ†å¼€è®¡ç¨ï¼ˆå¹´ç»ˆå¥–å•ç‹¬è®¡ç¨ï¼‰</h3>
          <div id="separateTable"></div>
        </div>
      </div>
      <div class="summary">
        <h3>å¹´åº¦æ±‡æ€»</h3>
        <div class="summary-grid" id="summary"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  
  // ä¸ªäººæ‰€å¾—ç¨ç¨ç‡è¡¨ï¼ˆ2024å¹´ï¼‰
  const taxBrackets = [
    { min: 0, max: 36000, rate: 0.03, deduction: 0 },
    { min: 36000, max: 144000, rate: 0.10, deduction: 2520 },
    { min: 144000, max: 300000, rate: 0.20, deduction: 16920 },
    { min: 300000, max: 420000, rate: 0.25, deduction: 31920 },
    { min: 420000, max: 660000, rate: 0.30, deduction: 52920 },
    { min: 660000, max: 960000, rate: 0.35, deduction: 85920 },
    { min: 960000, max: Infinity, rate: 0.45, deduction: 181920 }
  ];
  
  // å¹´ç»ˆå¥–å•ç‹¬è®¡ç¨ç¨ç‡è¡¨
  const bonusTaxBrackets = [
    { min: 0, max: 3000, rate: 0.03, deduction: 0 },
    { min: 3000, max: 12000, rate: 0.10, deduction: 210 },
    { min: 12000, max: 25000, rate: 0.20, deduction: 1410 },
    { min: 25000, max: 35000, rate: 0.25, deduction: 2660 },
    { min: 35000, max: 55000, rate: 0.30, deduction: 4410 },
    { min: 55000, max: 80000, rate: 0.35, deduction: 7160 },
    { min: 80000, max: Infinity, rate: 0.45, deduction: 15160 }
  ];
  
  function calculateTax(income) {
    for (const bracket of taxBrackets) {
      if (income > bracket.min && income <= bracket.max) {
        return income * bracket.rate - bracket.deduction;
      }
    }
    return 0;
  }
  
  function calculateBonusTax(bonus) {
    const monthlyBonus = bonus / 12;
    for (const bracket of bonusTaxBrackets) {
      if (monthlyBonus > bracket.min && monthlyBonus <= bracket.max) {
        return bonus * bracket.rate - bracket.deduction * 12;
      }
    }
    return 0;
  }
  
  function formatMoney(amount) {
    // ç¡®ä¿ä¿ç•™ä¸¤ä½å°æ•°ï¼Œä¸å–æ•´
    const num = Number(amount);
    if (isNaN(num)) return '0.00';
    return num.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  
  // æ·»åŠ ä¸“é¡¹æ‰£é™¤è¡Œ
  function addSpecialDeductionRow() {
    const tbody = $('specialDeductionBody');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td data-label="ç±»å‹" style="padding: 8px;">
        <select class="deduction-type" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="monthly">æ¯æœˆ</option>
          <option value="yearly">æ¯å¹´</option>
        </select>
      </td>
      <td data-label="é‡‘é¢" style="padding: 8px;">
        <input type="number" class="deduction-amount" value="0" step="0.01" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" />
      </td>
      <td data-label="æ“ä½œ" style="padding: 8px; text-align: center;">
        <button type="button" class="remove-row" style="padding: 4px 12px; background: #f56565; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">- åˆ é™¤</button>
      </td>
    `;
    tbody.appendChild(row);
    
    // ç»‘å®šåˆ é™¤æŒ‰é’®
    row.querySelector('.remove-row').addEventListener('click', () => {
      row.remove();
    });
  }
  
  // åˆå§‹åŒ–ï¼šæ·»åŠ ä¸€è¡Œ
  addSpecialDeductionRow();
  
  // æ·»åŠ æŒ‰é’®äº‹ä»¶
  $('addSpecialDeduction').addEventListener('click', addSpecialDeductionRow);
  
  // è®¡ç®—ä¸“é¡¹æ‰£é™¤æ€»é¢
  function calculateSpecialDeduction() {
    const rows = $('specialDeductionBody').querySelectorAll('tr');
    let total = 0;
    rows.forEach(row => {
      const type = row.querySelector('.deduction-type').value;
      const amount = Number(row.querySelector('.deduction-amount').value) || 0;
      if (type === 'monthly') {
        total += amount * 12; // æ¯æœˆä¹˜ä»¥12
      } else {
        total += amount; // æ¯å¹´ç›´æ¥ç›¸åŠ 
      }
    });
    return total;
  }
  
  $('calculate').addEventListener('click', () => {
    const monthlySalary = Number($('monthlySalary').value) || 0;
    const bonus = Number($('bonus').value) || 0;
    const bonusMonth = Number($('bonusMonth').value);
    const specialDeduction = calculateSpecialDeduction(); // è®¡ç®—ä¸“é¡¹æ‰£é™¤æ€»é¢
    const monthlySpecialDeduction = specialDeduction / 12; // æ¯æœˆä¸“é¡¹æ‰£é™¤
    
    // äº”é™©ä¸€é‡‘åŸºæ•°ï¼ˆç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ªåŸºæ•°ï¼‰
    const insuranceBaseRaw = Number($('insuranceBase').value) || monthlySalary;
    const insuranceMax = Number($('insuranceMax').value) || 25299;
    const housingMax = Number($('housingMax').value) || 40694;
    
    // åº”ç”¨ä¸Šé™ï¼šäº”é™©åŸºæ•°ä¸èƒ½è¶…è¿‡ä¸Šé™ï¼Œå…¬ç§¯é‡‘åŸºæ•°ä¸èƒ½è¶…è¿‡ä¸Šé™
    const insuranceBase = Math.min(insuranceBaseRaw, insuranceMax);
    const housingBase = Math.min(insuranceBaseRaw, housingMax);
    
    // äº”é™©ä¸€é‡‘æ¯”ä¾‹
    const pensionRate = Number($('pensionRate').value) / 100 || 0.08;
    const medicalRate = Number($('medicalRate').value) / 100 || 0.02;
    const unemploymentRate = Number($('unemploymentRate').value) / 100 || 0.005;
    const housingRate = Number($('housingRate').value) / 100 || 0.12;
    const medicalAccountRate = Number($('medicalAccountRate').value) / 100 || 0.02;
    
    // è®¡ç®—æ¯æœˆæ‰£é™¤ï¼ˆç»Ÿä¸€ä½¿ç”¨insuranceBaseä½œä¸ºäº”é™©åŸºæ•°ï¼‰
    const monthlyPension = insuranceBase * pensionRate;
    const monthlyMedical = insuranceBase * medicalRate;
    const monthlyUnemployment = insuranceBase * unemploymentRate;
    const monthlyHousing = housingBase * housingRate;
    const monthlyMedicalAccount = insuranceBase * medicalAccountRate; // åŒ»ä¿ä¸ªäººè´¦æˆ·
    const monthlyHousingAccount = housingBase * housingRate * 2; // å…¬ç§¯é‡‘è´¦æˆ·ï¼ˆä¸ªäºº+å…¬å¸ï¼‰
    const monthlyFiveInsurance = monthlyPension + monthlyMedical + monthlyUnemployment; // äº”é™©ï¼ˆä¸å«å·¥ä¼¤ã€ç”Ÿè‚²ï¼Œå› ä¸ºä¸ªäººä¸ç¼´è´¹ï¼‰
    const monthlyDeduction = monthlyPension + monthlyMedical + monthlyUnemployment + monthlyHousing;
    
    // å¹´åº¦æ‰£é™¤æ€»é¢
    const annualDeduction = monthlyDeduction * 12;
    const annualMedicalAccount = monthlyMedicalAccount * 12;
    const annualHousing = monthlyHousingAccount * 12; // å…¬ç§¯é‡‘è´¦æˆ·æ€»é¢ï¼ˆä¸ªäºº+å…¬å¸ï¼‰
    
    // åˆå¹¶è®¡ç¨è®¡ç®—
    const combinedAnnualIncome = monthlySalary * 12 + bonus;
    const combinedTaxableIncome = combinedAnnualIncome - annualDeduction - 60000 - specialDeduction; // 6ä¸‡åŸºæœ¬æ‰£é™¤ + ä¸“é¡¹æ‰£é™¤
    const combinedTax = combinedTaxableIncome > 0 ? calculateTax(combinedTaxableIncome) : 0;
    const combinedNetIncome = combinedAnnualIncome - annualDeduction - combinedTax;
    
    // åˆ†å¼€è®¡ç¨è®¡ç®—
    const separateAnnualIncome = monthlySalary * 12;
    const separateTaxableIncome = separateAnnualIncome - annualDeduction - 60000 - specialDeduction;
    const separateTax = separateTaxableIncome > 0 ? calculateTax(separateTaxableIncome) : 0;
    const bonusTax = calculateBonusTax(bonus);
    const separateNetIncome = separateAnnualIncome - annualDeduction - separateTax + bonus - bonusTax;
    
    // è·å–ç¨ç‡
    function getTaxRate(income) {
      for (const bracket of taxBrackets) {
        if (income > bracket.min && income <= bracket.max) {
          return (bracket.rate * 100).toFixed(1) + '%';
        }
      }
      return '0%';
    }
    
    function getBonusTaxRate(bonus) {
      const monthlyBonus = bonus / 12;
      for (const bracket of bonusTaxBrackets) {
        if (monthlyBonus > bracket.min && monthlyBonus <= bracket.max) {
          return (bracket.rate * 100).toFixed(1) + '%';
        }
      }
      return '0%';
    }
    
    // ç”Ÿæˆæœˆåº¦è¡¨æ ¼
    function generateMonthlyTable(isCombined) {
      let html = '<table><thead><tr><th>æœˆä»½</th><th>æœˆè–ª</th><th>äº”é™©</th><th>ä¸€é‡‘</th><th>ä¸ªç¨(ç¨ç‡)</th><th>ç´¯è®¡è®¡ç¨æ•°é¢</th><th>å®å‘å·¥èµ„</th><th>åŒ»ä¿è´¦æˆ·</th><th>å…¬ç§¯é‡‘è´¦æˆ·</th></tr></thead><tbody>';
      
      let totalTax = 0;
      let totalNet = 0;
      
      for (let month = 1; month <= 12; month++) {
        let currentMonthSalary = monthlySalary;
        let monthBonus = 0;
        let monthTax = 0;
        
        if (month === bonusMonth) {
          monthBonus = bonus;
        }
        
        // ç´¯è®¡é¢„æ‰£æ³•è®¡ç®—ä¸ªç¨
        let cumulativeIncome = 0;
        let cumulativeDeduction = 0;
        let cumulativeTax = 0;
        let prevCumulativeTax = 0;
        
        if (isCombined) {
          // åˆå¹¶è®¡ç¨ï¼šå¹´ç»ˆå¥–å¹¶å…¥å½“æœˆ
          for (let m = 1; m <= month; m++) {
            cumulativeIncome += currentMonthSalary;
            if (m === bonusMonth) {
              cumulativeIncome += bonus;
            }
            cumulativeDeduction += monthlyDeduction + 5000 + monthlySpecialDeduction; // æ¯æœˆ5000åŸºæœ¬æ‰£é™¤ + ä¸“é¡¹æ‰£é™¤
          }
          
          if (month > 1) {
            // è®¡ç®—ä¸Šä¸ªæœˆç´¯è®¡ç¨
            let prevCumIncome = 0;
            let prevCumDeduction = 0;
            for (let m = 1; m < month; m++) {
              prevCumIncome += currentMonthSalary;
              if (m === bonusMonth) {
                prevCumIncome += bonus;
              }
              prevCumDeduction += monthlyDeduction + 5000 + monthlySpecialDeduction;
            }
            const prevTaxable = prevCumIncome - prevCumDeduction;
            prevCumulativeTax = prevTaxable > 0 ? calculateTax(prevTaxable) : 0;
          }
          
          const cumulativeTaxable = cumulativeIncome - cumulativeDeduction;
          cumulativeTax = cumulativeTaxable > 0 ? calculateTax(cumulativeTaxable) : 0;
          monthTax = cumulativeTax - prevCumulativeTax;
        } else {
          // åˆ†å¼€è®¡ç¨ï¼šå¹´ç»ˆå¥–å•ç‹¬è®¡ç¨
          if (month === bonusMonth) {
            // å¹´ç»ˆå¥–æœˆä»½ï¼Œæœˆè–ªçš„ä¸ªç¨å•ç‹¬è®¡ç®—
            cumulativeIncome = currentMonthSalary * month;
            cumulativeDeduction = (monthlyDeduction + 5000 + monthlySpecialDeduction) * month;
            const cumulativeTaxable = cumulativeIncome - cumulativeDeduction;
            cumulativeTax = cumulativeTaxable > 0 ? calculateTax(cumulativeTaxable) : 0;
            
            if (month > 1) {
              const prevIncome = currentMonthSalary * (month - 1);
              const prevDeduction = (monthlyDeduction + 5000 + monthlySpecialDeduction) * (month - 1);
              const prevTaxable = prevIncome - prevDeduction;
              prevCumulativeTax = prevTaxable > 0 ? calculateTax(prevTaxable) : 0;
            }
            monthTax = cumulativeTax - prevCumulativeTax;
          } else {
            cumulativeIncome = currentMonthSalary * month;
            cumulativeDeduction = (monthlyDeduction + 5000 + monthlySpecialDeduction) * month;
            const cumulativeTaxable = cumulativeIncome - cumulativeDeduction;
            cumulativeTax = cumulativeTaxable > 0 ? calculateTax(cumulativeTaxable) : 0;
            
            if (month > 1) {
              const prevIncome = currentMonthSalary * (month - 1);
              const prevDeduction = (monthlyDeduction + 5000 + monthlySpecialDeduction) * (month - 1);
              const prevTaxable = prevIncome - prevDeduction;
              prevCumulativeTax = prevTaxable > 0 ? calculateTax(prevTaxable) : 0;
            }
            monthTax = cumulativeTax - prevCumulativeTax;
          }
        }
        
        // è®¡ç®—ç´¯è®¡è®¡ç¨æ•°é¢ï¼ˆæœˆè–ªéƒ¨åˆ†ï¼‰
        let cumulativeTaxable = 0;
        if (isCombined) {
          cumulativeTaxable = cumulativeIncome - cumulativeDeduction;
        } else {
          // åˆ†å¼€è®¡ç¨æ—¶ï¼Œç´¯è®¡è®¡ç¨æ•°é¢çš„è®¡ç®—æ–¹å¼ä¸åˆå¹¶è®¡ç¨ä¿æŒä¸€è‡´
          cumulativeTaxable = cumulativeIncome - cumulativeDeduction;
        }
        // ç´¯è®¡è®¡ç¨æ•°é¢ä¸èƒ½å°äº0
        cumulativeTaxable = Math.max(0, cumulativeTaxable);
        
        // è·å–å½“å‰ç¨ç‡
        let taxRateText = getTaxRate(cumulativeTaxable);
        
        // åˆå¹¶è®¡ç¨æ—¶ï¼Œéœ€è¦æ‹†åˆ†æœˆè–ªå’Œå¹´ç»ˆå¥–çš„ä¸ªç¨
        let salaryTax = monthTax;
        let bonusTax = 0;
        let bonusTaxRateText = '';
        
        if (isCombined && month === bonusMonth && monthBonus > 0) {
          // è®¡ç®—ä¸å«å¹´ç»ˆå¥–çš„ç´¯è®¡ä¸ªç¨
          let incomeWithoutBonus = 0;
          let deductionWithoutBonus = 0;
          for (let m = 1; m <= month; m++) {
            incomeWithoutBonus += currentMonthSalary;
            deductionWithoutBonus += monthlyDeduction + 5000 + monthlySpecialDeduction;
          }
          const taxableWithoutBonus = incomeWithoutBonus - deductionWithoutBonus;
          const taxWithoutBonus = taxableWithoutBonus > 0 ? calculateTax(taxableWithoutBonus) : 0;
          
          // è®¡ç®—ä¸å«å¹´ç»ˆå¥–çš„ä¸Šæœˆç´¯è®¡ä¸ªç¨
          let prevTaxWithoutBonus = 0;
          if (month > 1) {
            let prevIncome = 0;
            let prevDeduction = 0;
            for (let m = 1; m < month; m++) {
              prevIncome += currentMonthSalary;
              prevDeduction += monthlyDeduction + 5000 + monthlySpecialDeduction;
            }
            const prevTaxable = prevIncome - prevDeduction;
            prevTaxWithoutBonus = prevTaxable > 0 ? calculateTax(prevTaxable) : 0;
          }
          
          // ä¸å«å¹´ç»ˆå¥–çš„å½“æœˆä¸ªç¨
          const monthTaxWithoutBonus = taxWithoutBonus - prevTaxWithoutBonus;
          
          // å¹´ç»ˆå¥–å¸¦æ¥çš„ä¸ªç¨å¢é‡ = å«å¹´ç»ˆå¥–çš„å½“æœˆä¸ªç¨ - ä¸å«å¹´ç»ˆå¥–çš„å½“æœˆä¸ªç¨
          bonusTax = monthTax - monthTaxWithoutBonus;
          // æœˆè–ªå¯¹åº”çš„ä¸ªç¨ = ä¸å«å¹´ç»ˆå¥–çš„å½“æœˆä¸ªç¨
          salaryTax = monthTaxWithoutBonus;
          bonusTaxRateText = getTaxRate(cumulativeTaxable);
        }
        
        const monthNet = currentMonthSalary - monthlyDeduction - salaryTax;
        totalTax += monthTax; // è¿™é‡ŒåŠ çš„æ˜¯å½“æœˆæ€»ä¸ªç¨ï¼ˆåŒ…å«å¹´ç»ˆå¥–ï¼‰
        totalNet += monthNet;
        
        // æœˆè–ªè¡Œ
        html += `<tr style="height: auto; line-height: 1.4;">
          <td data-label="æœˆä»½" style="padding: 8px 6px;">${month}æœˆ</td>
          <td data-label="æœˆè–ª" style="padding: 8px 6px;">${formatMoney(currentMonthSalary)}</td>
          <td data-label="äº”é™©" style="padding: 8px 6px;">${formatMoney(monthlyFiveInsurance)}</td>
          <td data-label="ä¸€é‡‘" style="padding: 8px 6px;">${formatMoney(monthlyHousing)}</td>
          <td data-label="ä¸ªç¨(ç¨ç‡)" style="padding: 8px 6px;">${formatMoney(salaryTax)} (${taxRateText})</td>
          <td data-label="ç´¯è®¡è®¡ç¨æ•°é¢" style="padding: 8px 6px;">${formatMoney(cumulativeTaxable)}</td>
          <td data-label="å®å‘å·¥èµ„" style="padding: 8px 6px;"><strong>${formatMoney(monthNet)}</strong></td>
          <td data-label="åŒ»ä¿è´¦æˆ·" style="padding: 8px 6px;">${formatMoney(monthlyMedicalAccount)}</td>
          <td data-label="å…¬ç§¯é‡‘è´¦æˆ·" style="padding: 8px 6px;">${formatMoney(monthlyHousingAccount)}</td>
        </tr>`;
        
        // å¹´ç»ˆå¥–å•ç‹¬ä¸€è¡Œï¼ˆå¦‚æœæœ‰ï¼‰
        if (month === bonusMonth && monthBonus > 0) {
          if (!isCombined) {
            // åˆ†å¼€è®¡ç¨æ—¶ï¼Œå¹´ç»ˆå¥–å•ç‹¬è®¡ç¨
            bonusTax = calculateBonusTax(bonus);
            bonusTaxRateText = getBonusTaxRate(bonus);
            totalTax += bonusTax;
            totalNet += bonus - bonusTax;
          } else {
            // åˆå¹¶è®¡ç¨æ—¶ï¼ŒbonusTaxå·²ç»åœ¨ä¸Šé¢è®¡ç®—äº†
            totalNet += monthBonus - bonusTax;
          }
          
          html += `<tr style="background: #fff5e6; height: auto; line-height: 1.4;">
            <td data-label="æœˆä»½" style="padding: 8px 6px;">${month}æœˆ-å¹´ç»ˆå¥–</td>
            <td data-label="å¹´ç»ˆå¥–" style="padding: 8px 6px;">${formatMoney(monthBonus)}</td>
            <td data-label="äº”é™©" style="padding: 8px 6px;">-</td>
            <td data-label="ä¸€é‡‘" style="padding: 8px 6px;">-</td>
            <td data-label="ä¸ªç¨(ç¨ç‡)" style="padding: 8px 6px;">${formatMoney(bonusTax)} (${bonusTaxRateText})</td>
            <td data-label="ç´¯è®¡è®¡ç¨æ•°é¢" style="padding: 8px 6px;">-</td>
            <td data-label="å®å‘å·¥èµ„" style="padding: 8px 6px;"><strong>${formatMoney(monthBonus - bonusTax)}</strong></td>
            <td data-label="åŒ»ä¿è´¦æˆ·" style="padding: 8px 6px;">-</td>
            <td data-label="å…¬ç§¯é‡‘è´¦æˆ·" style="padding: 8px 6px;">-</td>
          </tr>`;
        }
      }
      
      html += '</tbody></table>';
      return html;
    }
    
    $('combinedTable').innerHTML = generateMonthlyTable(true);
    $('separateTable').innerHTML = generateMonthlyTable(false);
    
    // ç”Ÿæˆæ±‡æ€»
    // ç¨å+å…¬ç§¯é‡‘åˆ°è´¦æ€»é¢ï¼ˆè§†ä¸ºå®é™…åˆ°æ‰‹ï¼‰
    const combinedActualIncome = combinedNetIncome + annualHousing;
    const separateActualIncome = separateNetIncome + annualHousing;

    const summaryHtml = `
      <div class="summary-item">
        <strong>åˆå¹¶è®¡ç¨å¹´åº¦ç¨åæ”¶å…¥</strong>
        <span>${formatMoney(combinedNetIncome)}</span>
      </div>
      <div class="summary-item">
        <strong>åˆ†å¼€è®¡ç¨å¹´åº¦ç¨åæ”¶å…¥</strong>
        <span>${formatMoney(separateNetIncome)}</span>
      </div>
      <div class="summary-item">
        <strong>åˆå¹¶è®¡ç¨å®é™…åˆ°æ‰‹(ç¨å+å…¬ç§¯é‡‘)</strong>
        <span>${formatMoney(combinedActualIncome)}</span>
      </div>
      <div class="summary-item">
        <strong>åˆ†å¼€è®¡ç¨å®é™…åˆ°æ‰‹(ç¨å+å…¬ç§¯é‡‘)</strong>
        <span>${formatMoney(separateActualIncome)}</span>
      </div>
      <div class="summary-item">
        <strong>åˆå¹¶è®¡ç¨å¹´åº¦ä¸ªç¨</strong>
        <span>${formatMoney(combinedTax)}</span>
      </div>
      <div class="summary-item">
        <strong>åˆ†å¼€è®¡ç¨å¹´åº¦ä¸ªç¨</strong>
        <span>${formatMoney(separateTax + bonusTax)}</span>
      </div>
      <div class="summary-item">
        <strong>å¹´åº¦åŒ»ä¿è´¦æˆ·æ€»é¢</strong>
        <span>${formatMoney(annualMedicalAccount)}</span>
      </div>
      <div class="summary-item">
        <strong>å¹´åº¦å…¬ç§¯é‡‘è´¦æˆ·æ€»é¢</strong>
        <span>${formatMoney(annualHousing)}</span>
      </div>
      <div class="summary-item highlight">
        <strong>æœ€ä¼˜æ–¹æ¡ˆ</strong>
        <span>${combinedNetIncome > separateNetIncome ? 'åˆå¹¶è®¡ç¨' : 'åˆ†å¼€è®¡ç¨'}</span>
      </div>
      <div class="summary-item highlight">
        <strong>æœ€ä¼˜æ–¹æ¡ˆèŠ‚çœ</strong>
        <span>${formatMoney(Math.abs(combinedNetIncome - separateNetIncome))}</span>
      </div>
    `;
    
    $('summary').innerHTML = summaryHtml;
    $('results').style.display = 'block';
  });
  
  // åˆå§‹è®¡ç®—
  setTimeout(() => { $('calculate').click(); }, 200);
})();
</script>
</body>
</html>

